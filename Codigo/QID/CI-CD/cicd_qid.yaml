steps:
  # Paso 1: Ejecutar las pruebas unitarias
  - name: 'python:3.9'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install -r Codigo/QID/qid_publisher/requirements.txt
        python -m unittest Codigo/QID/test/test_qid_publisher.py

  # Paso 2: Desplegar la Cloud Function
  - name: 'gcr.io/cloud-builders/gcloud'
    args: [
            'functions', 'deploy', 'qid_publisher',
            '--region=europe-west3',
            '--source=Codigo/QID/qid_publisher', 
            '--trigger-http',
            '--runtime=python39',
            '--service-account=dataquality@diegucci-dq.iam.gserviceaccount.com',
            '--set-secrets=DQ_KEY=data_quality_key:latest',
            '--set-env-vars=QID_BUCKET=qid_bucket',
            '--set-env-vars=QID_SQL=qid_sql.sql',
            '--set-env-vars=MATRIX_FILE=MatrixInput_v1.1'
          ]
