steps:
  # Paso 1: Ejecutar las pruebas unitarias
  - name: 'python:3.9'
    entrypoint: 'bash'
    id: testing_functions
    args:
      - '-c'
      - |
        pip install -r Codigo/QAE/qae_notification/requirements.txt
        python -m unittest Codigo/QAE/test/test_qae_notification.py

        pip install -r Codigo/QAE/qae_publisher/requirements.txt
        python -m unittest Codigo/QAE/test/test_qae_publisher.py

  # Paso 2: Desplegar la Cloud Function
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if gcloud functions describe qae_notification --project=diegucci-dq --region=europe-west3 > /dev/null 2>&1; then
          echo "La funci贸n existe."
        else
          echo "La funci贸n no existe."
          exit 1
        fi
    waitFor: ['testing_functions']

  - name: 'gcr.io/cloud-builders/gcloud'
    args: [
            'functions', 'deploy', 'qae_notification',
            '--region=europe-west3',
            '--source=Codigo/QAE/qae_notification',
          ]
    
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if gcloud functions describe qae_publisher --project=diegucci-dq --region=europe-west3 > /dev/null 2>&1; then
          echo "La funci贸n existe."
        else
          echo "La funci贸n no existe."
          exit 1
        fi
    waitFor: ['testing_functions']

  - name: 'gcr.io/cloud-builders/gcloud'
    args: [
            'functions', 'deploy', 'qae_publisher',
            '--region=europe-west3',
            '--source=Codigo/QAE/qae_publisher',
          ]
